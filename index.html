<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVA Volunteer Check-in</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="status-container" class="text-center p-8 bg-white rounded-lg shadow-lg max-w-md w-full">
        <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
        
        <!-- Status Title -->
        <h1 id="status-title" class="text-2xl font-bold text-gray-800">Volunteer Check-in</h1>

        <!-- Status Message -->
        <div id="status-message" class="mt-4 text-gray-600">
             <p>Please sign in to complete the volunteer check-in.</p>
        </div>
        
        <!-- Google Sign-In Button -->
        <div id="google-signin-button-container" class="mt-6 flex justify-center"></div>

    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxVvYA3ivr1rYfDN-5EPUes4wvCu8a-OoeiZ7AIY4goS8aRKAnMeWYN68-8QVHT9CT9/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";

        function updateStatus(title, message, isError = false, showSpinner = false) {
            document.getElementById('status-title').textContent = title;
            let iconHtml = '';
            if (isError) {
                iconHtml = '<i class="ph-x-circle text-5xl text-red-500 mx-auto mb-4"></i>';
            } else if (showSpinner) {
                 iconHtml = '<i class="ph-spinner-gap text-5xl text-teal-600 mx-auto animate-spin mb-4"></i>';
            }
            document.getElementById('status-message').innerHTML = iconHtml + `<p>${message}</p>`;
        }

        function handleCredentialResponse(response) {
            const id_token = response.credential;
            const urlParams = new URLSearchParams(window.location.search);
            const signupId = urlParams.get('signupId');

            if (!signupId) {
                updateStatus('Check-in Failed', 'Error: No Signup ID was found in the URL. Please scan the QR code again.', true);
                return;
            }
            
            updateStatus('Validating Check-in...', 'Please wait a moment.', false, true);
            document.getElementById('google-signin-button-container').style.display = 'none';

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', // Use no-cors to prevent the browser from blocking the request
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'completeSignupFromQR',
                    signupId: signupId,
                    token: id_token
                })
            })
            .then(() => {
                // Since we can't read the response with no-cors, we assume success
                updateStatus('Check-in Complete!', 'Thank you! The volunteer hours have been successfully marked as completed.');
            })
            .catch(error => {
                // This catch block will likely only catch network errors, not application errors from the script
                console.error('Check-in Fetch Error:', error);
                updateStatus('Check-in Failed', `An error occurred: Load failed. Please try again.`, true);
            });
        }

        window.onload = function () {
            try {
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse
                });
                google.accounts.id.renderButton(
                    document.getElementById('google-signin-button-container'),
                    { theme: "outline", size: "large" }
                );
            } catch (error) {
                console.error("Google Sign-In initialization failed:", error);
                updateStatus('Initialization Failed', `Could not initialize Google Sign-In. Error: ${error.message}. Please check your Client ID and Authorized JavaScript Origins in the Google Cloud Console.`, true);
            }
             if (typeof phosphor !== 'undefined') {
                phosphor.replace();
            }
        };
    </script>

</body>
</html>
