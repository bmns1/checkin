
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVA Volunteer Check-in</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="status-container" class="text-center p-8 bg-white rounded-lg shadow-lg max-w-md w-full">
        <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-20 w-auto mx-auto mb-4">
        <h1 class="text-2xl font-bold text-gray-800">Volunteer Check-in</h1>
        
        <div id="status-icon" class="mt-6">
             <i class="ph-spinner-gap text-6xl text-teal-600 mx-auto animate-spin"></i>
        </div>
        
        <h2 id="status-title" class="text-xl font-semibold text-gray-700 mt-4">Initializing...</h2>
        <p id="status-message" class="text-gray-500 mt-2">Preparing the check-in process.</p>
        
        <div id="google-signin-button-container" class="mt-6"></div>
    </div>

    <script>
        const PARENT_PORTAL_BACKEND = 'https://script.google.com/macros/s/AKfycbxVvYA3ivr1rYfDN-5EPUes4wvCu8a-OoeiZ7AIY4goS8aRKAnMeWYN68-8QVHT9CT9/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";

        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const statusIcon = document.getElementById('status-icon');

        function updateStatus(title, message, isError = false) {
            console.log(`[DEBUG] Status Update: ${title} - ${message}`);
            statusTitle.textContent = title;
            statusMessage.innerHTML = message; // Use innerHTML to allow links
            if (isError) {
                statusIcon.innerHTML = '<i class="ph-x-circle text-6xl text-red-500 mx-auto"></i>';
            }
        }
        
        function handleCredentialResponse(response) {
            console.log("[DEBUG] Step 3: Google Sign-In successful. Received token.");
            updateStatus("Validation Successful", "Completing the check-in process...");
            const id_token = response.credential;
            const signupId = new URLSearchParams(window.location.search).get('signupId');

            if (!signupId) {
                updateStatus("Check-in Failed", "No Signup ID found in the URL. Please scan the QR code again.", true);
                return;
            }

            console.log(`[DEBUG] Step 4: Sending check-in request for SignupID: ${signupId}`);
            fetch(PARENT_PORTAL_BACKEND, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'completeSignupFromQR',
                    signupId: signupId,
                    token: id_token
                })
            })
            .then(() => {
                console.log("[DEBUG] Step 5: Check-in request sent successfully.");
                updateStatus("Check-in Complete!", "Thank you for volunteering! Your hours have been recorded.");
                statusIcon.innerHTML = '<i class="ph-check-circle text-6xl text-green-500 mx-auto"></i>';
            })
            .catch(error => {
                console.error('Check-in fetch error:', error);
                updateStatus("Check-in Failed", `An error occurred: ${error.message}. Please try again.`, true);
            });
        }
        
        window.onload = function () {
            console.log("[DEBUG] Step 1: Page loaded. Initializing Google Sign-In.");
            updateStatus("Initializing Authentication...", "Please wait a moment.");
            
            try {
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse
                });
                
                console.log("[DEBUG] Step 2: Google library initialized. Rendering One Tap prompt.");
                google.accounts.id.prompt((notification) => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        console.warn("[DEBUG] One Tap prompt was not shown. Reason:", notification.getNotDisplayedReason());
                        updateStatus("Manual Sign-in Required", "Please click the button below to continue.");
                         google.accounts.id.renderButton(
                            document.getElementById('google-signin-button-container'),
                            { theme: "outline", size: "large" } 
                        );
                    }
                });

            } catch (error) {
                console.error("Google Sign-In initialization failed:", error);
                updateStatus("Initialization Failed", `Could not initialize Google Sign-In. Error: ${error.message}. Please check your Client ID and Authorized JavaScript Origins in the Google Cloud Console.`, true);
            }
        };
    </script>
</body>
</html>
